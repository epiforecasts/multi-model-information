---
title: "Characterising information loss due to aggregating epidemic model outputs"
output: html_document
---

```{r set-up, include=FALSE}
# Set up Rmarkdown and workspace -----
library(here)
library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)
library(patchwork)
knitr::opts_chunk$set(eval = TRUE, echo = FALSE,
                      message = FALSE, warning = FALSE,
                      eval.after = "fig.cap")
options(digits = 2)

local <- TRUE # FALSE = download data from hub git remote, TRUE = use copy in this repo

# Prettier formatting -----
# targets
target_levels <- c("ES inc case", "BE inc case", "NL inc case", 
                   "BE inc death", "NL inc death")
target_labels <- c("ES cases", "BE cases", "NL cases", 
                   "BE deaths", "NL deaths")
names(target_levels) <- target_labels

# colours for scenarios
scenario_colours <- c("A" = "#e66101",
                      "B" = "#ca0020",
                      "C" = "#0571b0",
                      "D" = "#5e3c99",
                      "Weighted" = "grey50")
```


## Results

```{r load-samples}
# Load samples from all models together with observed data
source(here("code", "import-results.R"))
results <- import_projections(round = 2, local = local, n_model_min = 3) |> 
  mutate(target = ordered(x = paste(location, target_variable),
                          labels = target_labels))
```

```{r create-ensembles, warning=FALSE}
# Create three ensembles ("Sample", "Quantile", "Weighted")
source(here("code", "create-ensembles.R"))
truncate_weeks <- 2 # scoring evaluation against all data -2 weeks before now
ensembles <- create_ensembles(results = results, 
                              truncate_weeks = truncate_weeks,
                              quantiles = c(0.01, 0.05, 0.25, 0.5, 
                                            0.75, 0.95, 0.99)) |> 
  mutate(target = ordered(x = paste(location, target_variable),
                          labels = target_labels))
```

#### Comparison of all ensembles

Figure 1

```{r plot-ensembles, warning=FALSE, fig.height=8, fig.width=12}
# Plot: All targets' trajectories over time and by ensemble
source(here("code", "plot-ensembles.R"))
plots <- purrr::map(target_levels,
                    ~ plot_ensemble_results(ensembles, results, 
                                            set_target = .x,
                                            scenario_colours = scenario_colours))
figure_1 <- wrap_plots(plots, 
           ncol = length(plots), 
           guides = "collect") &
  theme(legend.position = "top")

# Save and print
ggsave(filename = here("output", "figure-1.jpg"),
       plot = figure_1, height = 8, width = 12)
figure_1
```

#### Difference between uncertainty ranges

Figure 2

```{r width-ensembles, fig.width = 8}
interval_ensembles <- ensembles |>
  mutate(quantile = as.numeric(as.character(sub("q0", "", quantile))),
         interval = round(2 * abs(0.5 - quantile), 2),
         type = if_else(quantile <= 0.5, "lower", "upper"))
duplicate_median <- interval_ensembles |>
  filter(quantile == 0.5) |>
  mutate(type = "upper")

width <- interval_ensembles |>
  bind_rows(duplicate_median) |>
  filter(scenario_id != "Weighted") |>
  select(-quantile) |>
  pivot_wider(names_from = "type") |>
  # Average across all scenarios and dates
  group_by(round, target, model, interval) |>
  summarise(upper = mean(upper),
            lower = mean(lower),
            .groups = "drop")

width_plot <- width |>
  ggplot(aes(x = interval,
             ymin = lower, ymax = upper,
             group = model,
             colour = model, fill = model)) +
  geom_ribbon(alpha = 0.25) +
  geom_linerange(alpha = 0.25) +
  geom_point(aes(y = lower), alpha = 0.5) +
  geom_point(aes(y = upper), alpha = 0.5) +
  scale_colour_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1") +
  labs(y = "Mean lower and upper interval bound per 100k",
       x = "Interval width",
       fill = "Ensemble data source",
       colour = "Ensemble data source") +
  facet_wrap(~target, nrow = 1,
             scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        strip.background = element_blank())

ggsave(filename = here("output", "figure-2.jpg"),
       plot = width_plot, width = 8)

width_plot
```

```{r end-projection-uncertainty}
proj_end <- ensembles |> 
  filter(scenario_id == "Weighted") |> 
  group_by(location, target_variable) |> 
  filter(target_end_date == max(target_end_date) & 
           quantile == "q0.99") |> 
  filter(value == max(value))

end_max <- results |> 
  group_by(location, target_variable) |>
  filter(target_end_date == max(target_end_date)) |> 
  filter(value_100k == max(value_100k))
```

#### Conditioning samples on an increasing amount of data
```{r weekly-ensembles}
# Create set of weekly ensembles with progressively increasing observed data
source(here("code", "create-weekly-ensemble.R"))
weekly_ensembles <- create_weekly_ensembles(results)
ensembles <- weekly_ensembles$ensembles  
weights <- weekly_ensembles$weights
```

[Text:]

- When weighted by inverse MAE, no sample received more than `r max(weights$weight)*100`% weight (among n=`r nrow(weights)/length(unique(weights$target))` samples for each target).


Figure 3. Weighted ensemble forecasts of incidence 4, 8, and 16 weeks ahead of available data, with available data increasing weekly over time. Showing median (lines) & 50% quantiles (shaded ribbons). Each sample trajectory started from 30 July 2022 and was weighted using its inverse mean absolute error against all available data. Consecutive weekly forecasts were created from updating weights with each week's observed data. We started with 4 weeks observed data and then created consecutive forecasts at each week, so that weights update with increasing weekly observed data becoming available. This meant the earliest forecast is an ensemble of sample trajectories from the 27 August 2022 (vertical dashed line), using 4 weeks' observed data to weight sample trajectories, and gives a 4 week ahead forecast for the 24 September (start of purple ribbon), an 8 week ahead forecast for the 22 October (start of pink ribbon), and 16 week forecast from 17 December 2022 (start of yellow ribbon). 

```{r plot-weekly-ensembles, fig.dim=c(10,10)}
# Plot -------------------------------------------
  # set up data for plotting
  obs_data <- results |>
    distinct(location, target_variable, target_end_date, obs_100k)
  # select only some horizons
weekly_ensemble_plot <- ensembles |>
    filter(horizon %in% c(4,8,16)) |>
    full_join(obs_data, by = c("location", "target_variable", "target_end_date"))

  # shape for plotting
  weekly_ensemble_plot <- weekly_ensemble_plot |>
    pivot_wider(names_from = quantile) |>
    mutate(median = q0.5) |>
    select(-q0.5) |>
    mutate(forecast_date = as.Date(forecast_date),
           target = factor(paste(location,
                                 gsub("inc ", "", target_variable))),
           scenario_id = factor(scenario_id),
           horizon_f = factor(horizon, levels = c(16,8,4), 
                              labels = c("16 weeks ago", "8 weeks ago", "4 weeks ago")))

# Plot
weekly_ensemble_plot <- weekly_ensemble_plot |>
    ggplot(aes(x = target_end_date,
               group = horizon_f,
               col = horizon_f,
               fill = horizon_f
    )) +
    # ----- Geoms
    # ensembles
    geom_ribbon(aes(ymin = q0.25, ymax = q0.75),
                col = NA, alpha = 0.4) +
    geom_line(aes(y = median), lwd = 1) +
    # observed data as points
    geom_point(aes(y = obs_100k),
               colour = "grey20", size = 0.6,
               show.legend = FALSE) +
    # show start date of weighted forecasting
    geom_vline(xintercept = min(weekly_ensembles$forecast_date),
               lty = 2) +
    # ----- Structure
    # facets
    facet_grid(rows = vars(target),
               scales = "free") +
    # labels
    labs(x = NULL, y = "Incidence per 100k",
         fill = "Conditioned on data up to",
         col = "Conditioned on data up to") +
    # scales
    scale_x_date(limits = c(min(results$target_end_date), NA),
                 breaks = "1 month", date_labels = "%b '%y") +
    scale_colour_viridis_d(option = "F",
                           begin = 0.2, end = 0.8,
                           alpha = 0.5,
                           direction = -1,
                           aesthetics = c("fill", "colour")) +
    # theme
    theme_bw() +
    theme(legend.position = "bottom",
          strip.background = element_blank())

ggsave(filename = "output/figure-3.jpg", height = 8, width = 8, 
         plot = weekly_ensemble_plot)
  
weekly_ensemble_plot
```

Figure 1.iii shows an ensemble from equally weighted simulated trajectories - that is the same as a 52-week-ahead forecast conditioned on 0-weeks-observed data (relative to the start of the projection). Figure 1.iv shows a 25-week-ahead ensemble weighted by simulations' performance based on 25-weeks-observed data.

We show varying lengths of forecasts repeatedly conditioned on simulated trajectories' performance against each week's data. We start with performance from 4-weeks-observed data and use this to weight an ensemble that forecasts 4, 8, or 16 weeks ahead into the future.


